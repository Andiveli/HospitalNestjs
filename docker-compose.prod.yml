# Hospital NestJS - Docker Compose for Production
# Usage: docker compose -f docker-compose.prod.yml up -d

services:
    # ========================================
    # NestJS Application
    # ========================================
    app:
        image: ${DOCKER_REGISTRY:-}hospital-api:${IMAGE_TAG:-latest}
        build:
            context: .
            dockerfile: Dockerfile
        container_name: hospital-api
        restart: always
        ports:
            - '${PORT:-3000}:3000'
        environment:
            - NODE_ENV=production
            - PORT=3000
            # Database
            - DB_TYPE=${DB_TYPE}
            - DATABASE_URL=${DATABASE_URL}
            # Redis
            - REDIS_HOST=${REDIS_HOST}
            - REDIS_PORT=${REDIS_PORT:-6379}
            # JWT
            - JWT_SECRET=${JWT_SECRET}
            # Frontend
            - FRONTEND_URL=${FRONTEND_URL}
            # Email
            - EMAIL_HOST=${EMAIL_HOST}
            - EMAIL_PORT=${EMAIL_PORT}
            - EMAIL_USER=${EMAIL_USER}
            - EMAIL_PASS=${EMAIL_PASS}
            # Storage (S3)
            - STORAGE_PROVIDER=${STORAGE_PROVIDER}
            - STORAGE_BUCKET=${STORAGE_BUCKET}
            - STORAGE_REGION=${STORAGE_REGION}
            - STORAGE_ACCESS_KEY_ID=${STORAGE_ACCESS_KEY_ID}
            - STORAGE_SECRET_ACCESS_KEY=${STORAGE_SECRET_ACCESS_KEY}
            - STORAGE_ENDPOINT=${STORAGE_ENDPOINT}
            # AWS (alternative)
            - AWS_S3_BUCKET=${AWS_S3_BUCKET}
            - AWS_REGION=${AWS_REGION}
            - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
            - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
            # Swagger
            - SWAGGER_TOKEN=${SWAGGER_TOKEN}
            # TURN servers for WebRTC
            - TURN_SERVERS=${TURN_SERVERS}
        deploy:
            resources:
                limits:
                    cpus: '1'
                    memory: 512M
                reservations:
                    cpus: '0.5'
                    memory: 256M
            restart_policy:
                condition: on-failure
                delay: 5s
                max_attempts: 3
                window: 120s
        networks:
            - hospital-network
        healthcheck:
            test:
                [
                    'CMD',
                    'wget',
                    '--no-verbose',
                    '--tries=1',
                    '--spider',
                    'http://localhost:3000/api',
                ]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 40s
        logging:
            driver: 'json-file'
            options:
                max-size: '10m'
                max-file: '3'

# ========================================
# Networks
# ========================================
networks:
    hospital-network:
        driver: bridge
