# Hospital NestJS - Docker Compose for Development
# Usage: docker compose up -d

services:
    # ========================================
    # NestJS Application
    # ========================================
    app:
        build:
            context: .
            dockerfile: Dockerfile
        container_name: hospital-api
        restart: unless-stopped
        ports:
            - '${PORT:-3000}:3000'
        dns:
            - 8.8.8.8
            - 8.8.4.4
        environment:
            - NODE_ENV=${NODE_ENV:-development}
            - PORT=3000
            # Database (uses your .env DATABASE_URL - e.g., Supabase)
            - DB_TYPE=${DB_TYPE:-postgres}
            - DATABASE_URL=${DATABASE_URL}
            # Redis
            - REDIS_HOST=redis
            - REDIS_PORT=6379
            # JWT
            - JWT_SECRET=${JWT_SECRET}
            # Frontend
            - FRONTEND_URL=${FRONTEND_URL:-http://localhost:5173}
            # Email
            - EMAIL_HOST=${EMAIL_HOST}
            - EMAIL_PORT=${EMAIL_PORT}
            - EMAIL_USER=${EMAIL_USER}
            - EMAIL_PASS=${EMAIL_PASS}
            # Storage (S3/MinIO)
            - STORAGE_PROVIDER=${STORAGE_PROVIDER:-local}
            - STORAGE_BUCKET=${STORAGE_BUCKET}
            - STORAGE_REGION=${STORAGE_REGION}
            - STORAGE_ACCESS_KEY_ID=${STORAGE_ACCESS_KEY_ID}
            - STORAGE_SECRET_ACCESS_KEY=${STORAGE_SECRET_ACCESS_KEY}
            - STORAGE_ENDPOINT=${STORAGE_ENDPOINT}
            # Swagger
            - SWAGGER_TOKEN=${SWAGGER_TOKEN}
        depends_on:
            redis:
                condition: service_healthy
        networks:
            - hospital-network
        healthcheck:
            test:
                [
                    'CMD',
                    'wget',
                    '--no-verbose',
                    '--tries=1',
                    '--spider',
                    'http://localhost:3000/api',
                ]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 40s

    # ========================================
    # PostgreSQL Database (Optional - for local development)
    # ========================================
    db:
        image: postgres:16-alpine
        container_name: hospital-db
        restart: unless-stopped
        ports:
            - '${DB_PORT:-5432}:5432'
        environment:
            - POSTGRES_USER=${DB_USER:-postgres}
            - POSTGRES_PASSWORD=${DB_PASS:-postgres}
            - POSTGRES_DB=${DB_NAME:-hospital}
        volumes:
            - postgres_data:/var/lib/postgresql/data
        networks:
            - hospital-network
        healthcheck:
            test:
                [
                    'CMD-SHELL',
                    'pg_isready -U ${DB_USER:-postgres} -d ${DB_NAME:-hospital}',
                ]
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 10s
        profiles:
            - local-db

    # ========================================
    # Redis Cache & Queue
    # ========================================
    redis:
        image: redis:7-alpine
        container_name: hospital-redis
        restart: unless-stopped
        ports:
            - '${REDIS_EXTERNAL_PORT:-6380}:6379'
        volumes:
            - redis_data:/data
        networks:
            - hospital-network
        healthcheck:
            test: ['CMD', 'redis-cli', 'ping']
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 10s
        command: redis-server --appendonly yes

    # ========================================
    # MinIO (S3-compatible storage) - Optional
    # ========================================
    minio:
        image: minio/minio:latest
        container_name: hospital-minio
        restart: unless-stopped
        ports:
            - '9000:9000'
            - '9001:9001'
        environment:
            - MINIO_ROOT_USER=${MINIO_ROOT_USER:-minioadmin}
            - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD:-minioadmin}
        volumes:
            - minio_data:/data
        networks:
            - hospital-network
        command: server /data --console-address ":9001"
        healthcheck:
            test: ['CMD', 'mc', 'ready', 'local']
            interval: 30s
            timeout: 20s
            retries: 3
        profiles:
            - storage

# ========================================
# Volumes
# ========================================
volumes:
    postgres_data:
        driver: local
    redis_data:
        driver: local
    minio_data:
        driver: local

# ========================================
# Networks
# ========================================
networks:
    hospital-network:
        driver: bridge
